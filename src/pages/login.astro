---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Log In" authLayout={true} showFooter={true}>
  <div class="auth-page">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1 class="auth-title">Welcome Back</h1>
          <p class="auth-subtitle">Sign in to your campus account</p>
        </div>

        <div id="errorBanner" class="error-banner" style="display:none">
          <span id="errorText"></span>
        </div>

        <form class="auth-form" id="loginForm" novalidate>
          <div class="form-group">
            <label class="form-label" for="email">FSC Student Email</label>
            <input
              class="form-input"
              id="email"
              type="email"
              placeholder="name@farmingdale.edu"
              autocomplete="email"
              required
            />
          </div>

          <div class="form-group">
            <div class="label-row">
              <label class="form-label" for="password">Password</label>
              <a href="#" class="forgot-link">Forgot?</a>
            </div>
            <div class="input-wrap">
              <input
                class="form-input"
                id="password"
                type="password"
                placeholder="••••••••"
                autocomplete="current-password"
                required
              />
              <button
                type="button"
                class="toggle-pw"
                id="togglePw"
                aria-label="Toggle password visibility"
              >
                <svg
                  id="eyeOpen"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg
                  id="eyeOff"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  style="display:none"
                >
                  <path
                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"
                  ></path>
                  <path
                    d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"
                  ></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
          </div>

          <button type="submit" class="btn-primary auth-submit" id="submitBtn"
            >Sign In</button
          >

          <div class="auth-separator">
            <span>New to the marketplace?</span>
          </div>

          <a href="/signup" class="btn-secondary">Create Student Account</a>
        </form>
      </div>

      <p class="auth-footer-text">
        By signing in, you agree to our <a href="#">Terms</a> and <a href="#"
          >Privacy Policy</a
        >
      </p>
    </div>
  </div>
</Layout>

<style>
  .auth-page {
    min-height: calc(100vh - 80px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    background-color: var(--gray-50);
    background-image:
      radial-gradient(at 0% 0%, var(--primary-soft) 0px, transparent 50%),
      radial-gradient(at 100% 100%, var(--accent-soft) 0px, transparent 50%);
  }

  .auth-container {
    width: 100%;
    max-width: 440px;
  }

  .auth-card {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-2xl);
    padding: 3rem;
    width: 100%;
    max-width: 480px;
    box-shadow: var(--shadow-xl);
    margin-bottom: 2rem;
  }

  @media (max-width: 540px) {
    .auth-page {
      padding: 1.5rem;
    }
    .auth-card {
      padding: 2rem 1.5rem;
    }
    .auth-title {
      font-size: 1.75rem;
    }
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .auth-title {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--gray-900);
    letter-spacing: -0.02em;
    margin-bottom: 0.5rem;
  }

  .auth-subtitle {
    font-size: 0.95rem;
    color: var(--gray-500);
  }

  .auth-form {
    display: flex;
    flex-direction: column;
  }

  .label-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
  }

  .forgot-link {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary);
    text-decoration: none;
  }

  .forgot-link:hover {
    text-decoration: underline;
  }

  .input-wrap {
    position: relative;
  }
  .input-wrap .form-input {
    padding-right: 3rem;
  }

  .toggle-pw {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray-400);
    display: flex;
    align-items: center;
    transition: color 0.15s;
    padding: 0.25rem;
  }

  .toggle-pw:hover {
    color: var(--gray-600);
  }

  .auth-submit {
    margin-top: 1rem;
    padding: 0.85rem;
  }

  .auth-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .auth-separator {
    text-align: center;
    margin: 2rem 0 1.5rem;
    position: relative;
  }

  .auth-separator::before {
    content: "";
    position: absolute;
    left: 0;
    top: 50%;
    width: 100%;
    height: 1px;
    background: var(--gray-100);
    z-index: 1;
  }

  .auth-separator span {
    position: relative;
    z-index: 2;
    background: var(--white);
    padding: 0 1rem;
    font-size: 0.85rem;
    color: var(--gray-400);
    font-weight: 500;
  }

  .auth-footer-text {
    text-align: center;
    font-size: 0.85rem;
    color: var(--gray-500);
  }

  .auth-footer-text a {
    color: var(--gray-700);
    font-weight: 600;
    text-decoration: none;
  }

  .auth-footer-text a:hover {
    text-decoration: underline;
  }

  .error-banner {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #b91c1c;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 480px) {
    .auth-card {
      padding: 2.5rem 1.5rem;
    }
  }
</style>

<script>
  import { isValidStudentEmail, supabase } from "../lib/supabase";

  const form = document.getElementById("loginForm") as HTMLFormElement;
  const errorBanner = document.getElementById("errorBanner") as HTMLElement;
  const errorText = document.getElementById("errorText") as HTMLElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;

  function showError(msg: string) {
    errorText.textContent = msg;
    errorBanner.style.display = "block";
  }

  function hideError() {
    errorBanner.style.display = "none";
  }

  // Toggle password visibility
  const toggleBtn = document.getElementById("togglePw");
  const pwInput = document.getElementById(
    "password",
  ) as HTMLInputElement | null;
  const eyeOpen = document.getElementById("eyeOpen") as HTMLElement | null;
  const eyeOff = document.getElementById("eyeOff") as HTMLElement | null;

  toggleBtn?.addEventListener("click", () => {
    if (!pwInput) return;
    const showing = pwInput.type === "text";
    pwInput.type = showing ? "password" : "text";
    if (eyeOpen) eyeOpen.style.display = showing ? "" : "none";
    if (eyeOff) eyeOff.style.display = showing ? "none" : "";
  });

  // Check if already logged in
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      window.location.href = "/marketplace";
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideError();

    const email = (document.getElementById("email") as HTMLInputElement).value
      .trim()
      .toLowerCase();
    const password = (document.getElementById("password") as HTMLInputElement)
      .value;

    if (!email) {
      showError("Please enter your email address.");
      return;
    }

    if (!isValidStudentEmail(email)) {
      showError("You must use a @farmingdale.edu email address.");
      return;
    }

    if (!password) {
      showError("Please enter your password.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Signing in...";

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      showError(error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = "Sign In";
      return;
    }

    // Success — redirect to marketplace
    window.location.href = "/marketplace";
  });
</script>
